import PronounTool from "../../domain/pronounTool.js";
import { DECLENSION_FIELDS } from "../../domain/pronounForms.js";
import { DECLENSION_SAMPLE_SENTENCES } from "../../domain/declensionData.js";
import { createRandomFullName } from "../../domain/names.js";

const tool = new PronounTool([]);

/**
 * Choose a placeholder person from input or fallbacks.
 * @param {Array<{firstName?: string, lastName?: string, isAutoGenerated?: boolean, lastNameSource?: string}>} names
 * @returns {{name: string, person: object, isAutoGenerated: boolean}}
 */
function pickPlaceholderPerson(names) {
  const availablePeople = (names || []).filter(
    (person) => String(person.firstName || "").trim().length > 0,
  );

  if (availablePeople.length > 0) {
    const picked =
      availablePeople[Math.floor(Math.random() * availablePeople.length)];
    return {
      name: picked.firstName,
      person: {
        firstName: picked.firstName,
        lastName: picked.lastName || "",
        lastNameSource: picked.lastNameSource || "user",
        isAutoGenerated: Boolean(picked.isAutoGenerated),
      },
      isAutoGenerated: Boolean(picked.isAutoGenerated),
    };
  }

  const fallback = createRandomFullName(null);
  return { name: fallback.firstName, person: fallback, isAutoGenerated: true };
}

/**
 * Create a labeled radio tab element pair.
 * @param {string} id
 * @param {string} labelText
 * @param {boolean} checked
 * @returns {{label: HTMLElement, input: HTMLInputElement}}
 */
function makeRadioTab(id, labelText, checked) {
  const label = document.createElement("label");
  label.className = "declension-tab";

  const input = document.createElement("input");
  input.type = "radio";
  input.name = "declension-tabs";
  input.id = id;
  input.checked = checked;

  const span = document.createElement("span");
  span.textContent = labelText;

  label.appendChild(input);
  label.appendChild(span);

  return { label, input };
}

/**
 * Toggle active tab panels and notify selection changes.
 * @param {object} viewState
 * @param {HTMLInputElement} activeInput
 */
function showPanel(viewState, activeInput) {
  const isTable = activeInput === viewState.tableInput;
  viewState.tableTab.classList.toggle("is-active", isTable);
  viewState.tablePanel.classList.toggle("is-hidden", !isTable);

  viewState.samplePanels.forEach(({ input, panel, label }) => {
    const isActive = input === activeInput;
    label.classList.toggle("is-active", isActive);
    panel.classList.toggle("is-hidden", !isActive);
  });

  if (viewState.onTabChange) {
    viewState.onTabChange(activeInput.id);
  }
}

/**
 * Handle tab changes by showing the corresponding panel.
 * @param {object} viewState
 * @param {Event} event
 */
function handleTabChange(viewState, event) {
  const target = event.target;
  if (!target) {
    return;
  }
  showPanel(viewState, target);
}

/**
 * Build the declension view with table and sample tabs.
 * @param {object} params
 * @returns {HTMLElement}
 */
export function createDeclensionView({
  pronounSets,
  names,
  initialTabId,
  onTabChange,
}) {
  const declensionWrap = document.createElement("div");
  declensionWrap.className = "declension-tables";

  if (!pronounSets || pronounSets.length === 0) {
    return declensionWrap;
  }

  const placeholder = pickPlaceholderPerson(names);
  const placeholderName = placeholder.name;

  const tabs = document.createElement("div");
  tabs.className = "declension-tabs";

  const tabList = document.createElement("div");
  tabList.className = "declension-tablist";

  const { label: tableTab, input: tableInput } = makeRadioTab(
    "declension-tab-table",
    "Tabelle",
    true,
  );

  tabList.appendChild(tableTab);
  tabs.appendChild(tabList);

  const tablePanel = document.createElement("div");
  tablePanel.className = "declension-tabpanel";
  tablePanel.setAttribute("aria-labelledby", tableInput.id);

  const samplePanels = [];

  const tableWrap = document.createElement("div");
  tableWrap.className = "declension-table-wrap";

  const table = document.createElement("table");
  table.className = "declension-table";

  const thead = document.createElement("thead");
  const headRow = document.createElement("tr");
  const corner = document.createElement("th");
  corner.scope = "col";
  corner.textContent = "Form";
  headRow.appendChild(corner);
  pronounSets.forEach((set) => {
    const th = document.createElement("th");
    th.scope = "col";
    th.textContent = set.bezeichnung;
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  DECLENSION_FIELDS.forEach((field) => {
    const row = document.createElement("tr");
    const th = document.createElement("th");
    th.scope = "row";
    th.textContent = field.label;
    row.appendChild(th);

    pronounSets.forEach((set) => {
      const td = document.createElement("td");
      const value = set.getForm(field.key, placeholderName);
      td.textContent = value || "â€”";
      row.appendChild(td);
    });

    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  tableWrap.appendChild(table);
  tablePanel.appendChild(tableWrap);

  pronounSets.forEach((set, index) => {
    const { label, input } = makeRadioTab(
      `declension-tab-sample-${index}`,
      set.bezeichnung,
      false,
    );
    tabList.appendChild(label);

    const panel = document.createElement("div");
    panel.className = "declension-tabpanel is-hidden";
    panel.setAttribute("aria-labelledby", input.id);

    const card = document.createElement("div");
    card.className = "declension-sample-card";

    DECLENSION_SAMPLE_SENTENCES.forEach((sentence) => {
      const rendered = tool.render(
        sentence,
        [
          {
            firstName: placeholder.person.firstName,
            lastName: placeholder.person.lastName,
            lastNameSource: placeholder.person.lastNameSource,
            isAutoGenerated: placeholder.isAutoGenerated,
          },
        ],
        [set],
        "single",
      );
      const p = document.createElement("p");
      p.innerHTML = rendered.html;
      card.appendChild(p);
    });

    panel.appendChild(card);
    samplePanels.push({ input, panel, label });
  });

  const viewState = {
    tableInput,
    tableTab,
    tablePanel,
    samplePanels,
    onTabChange,
  };

  const handleTabChangeBound = handleTabChange.bind(null, viewState);
  tableInput.addEventListener("change", handleTabChangeBound);
  samplePanels.forEach(({ input }) => {
    input.addEventListener("change", handleTabChangeBound);
  });

  const allTabs = [tableInput, ...samplePanels.map(({ input }) => input)];
  const preferredTab =
    allTabs.find((input) => input.id === initialTabId) || tableInput;
  preferredTab.checked = true;
  showPanel(viewState, preferredTab);

  tabs.appendChild(tablePanel);
  samplePanels.forEach(({ panel }) => tabs.appendChild(panel));
  declensionWrap.appendChild(tabs);
  return declensionWrap;
}
